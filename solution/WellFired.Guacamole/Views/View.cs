using System;using System.ComponentModel;using WellFired.Guacamole.Annotations;using WellFired.Guacamole.DataBinding;using WellFired.Guacamole.Event;using WellFired.Guacamole.Renderer;using WellFired.Guacamole.Styling;using WellFired.Guacamole.Types;namespace WellFired.Guacamole.Views{	public partial class View : BindableObject, IView	{	    protected UIRect FinalRenderRect = default(UIRect);	    private INativeRenderer _nativeRenderer;		private Style _style;		private UIRect _validRectRequest;	    public IView Content { get; set; }	    public View()		{			_validRectRequest = UIRect.Min;		}	    UIRect IView.RectRequest { get { return _validRectRequest; } set { _validRectRequest = value; } }	    public bool ValidRectRequest { get; set; }	    public string Id { get; set; }	    public INativeRenderer NativeRenderer		{			get			{				if (_nativeRenderer != default(INativeRenderer))					return _nativeRenderer;				INativeRenderer newNativeRenderer;				try				{					newNativeRenderer = NativeRendererHelper.CreateNativeRendererFor(GetType());					if (newNativeRenderer == null)						throw new Exception();				}				catch (Exception)				{					return null;				}				if (_nativeRenderer != null && newNativeRenderer != _nativeRenderer)				{					PropertyChanged -= OnPropertyChanged;					PropertyChanged -= _nativeRenderer.OnPropertyChanged;				}				_nativeRenderer = newNativeRenderer;			    if (_nativeRenderer == null)			        return _nativeRenderer;			    PropertyChanged += _nativeRenderer.OnPropertyChanged;			    PropertyChanged += OnPropertyChanged;			    _nativeRenderer.Control = this;			    _nativeRenderer.Create();			    return _nativeRenderer;			}		}		public virtual void Render(UIRect parentRect)		{		    FinalRenderRect.X = parentRect.X + RectRequest.X;		    FinalRenderRect.Y = parentRect.Y + RectRequest.Y;		    FinalRenderRect.Width = RectRequest.Width;		    FinalRenderRect.Height = RectRequest.Height;		    NativeRenderer.Render(FinalRenderRect);		    (Content as View)?.Render(FinalRenderRect);		}		[PublicAPI]		public virtual void InvalidateRectRequest()		{			ValidRectRequest = false;		    (Content as View)?.InvalidateRectRequest();		}	    protected override void OnPropertyChanged(object sender, PropertyChangedEventArgs e)		{			base.OnPropertyChanged(sender, e);			ProcessTriggers(e.PropertyName);		    (Content as View)?.OnPropertyChanged(sender, e);		}		private void UpdateNewStyle(Style style)		{			foreach (var setter in style.Setters)				SetValue(setter.Property, setter.Value);		}		private void ProcessTriggers(string propertyName)		{			if (Style == null)				return;			foreach (var trigger in Style.Triggers)			{				if (trigger.Property.PropertyName != propertyName)					continue;				var value = GetValue(trigger.Property);				if (!value.Equals(trigger.Value))					continue;				foreach (var setter in trigger.Setters)					SetValue(setter.Property, setter.Value);			}		}		public void RaiseEvent(IEvent raisedEvent)		{			var clickEvent = raisedEvent as ClickEvent;			if (clickEvent != null)			{				var clickable = this as IClickable;				clickable?.Click(clickEvent.Button);			}			var typeEvent = raisedEvent as TypeEvent;			if (typeEvent == null)				return;			var typeable = this as ITypeable;			typeable?.Type(typeEvent.Key);		}		public void FocusControl()		{			NativeRenderer.FocusControl();		}	}}